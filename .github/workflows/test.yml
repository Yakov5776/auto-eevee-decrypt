name: Fetch daily Telegram file

on:
  push:
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Telethon
        run: pip install telethon==1.38.1

      - name: Fetch file using Telethon
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TARGET_BOT_USERNAME: '@eeveedecrypterbot'
          ROBLOX_APP_URL: 'https://apps.apple.com/us/app/roblox/id431946152'
        run: |
          python <<'PYCODE'
          import asyncio
          import os
          from telethon import TelegramClient, events

          api_id = int(os.environ["TELEGRAM_API_ID"])
          api_hash = os.environ["TELEGRAM_API_HASH"]
          target_bot = os.environ["TARGET_BOT_USERNAME"]
          roblox_app_url = os.environ["ROBLOX_APP_URL"]

          async def main():
              client = TelegramClient("rblx_session", api_id, api_hash)
              await client.start()
              print("Logged in")

              # Send /getfile command to the bot
              await client.send_message(target_bot, roblox_app_url)

              # Wait for a document reply
              async for msg in client.iter_messages(target_bot, limit=10):
                  if msg.file:
                      path = await msg.download_media()
                      print(f"✅ File downloaded: {path}")
                      break
              else:
                  print("❌ No recent file message found.")

              await client.disconnect()

          asyncio.run(main())
          PYCODE
